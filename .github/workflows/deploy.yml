name: Deploy to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  DEPLOY_TIMEOUT: 600 # 10 –º–∏–Ω—É—Ç

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send Telegram notification - Start
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="üöÄ –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–µ–ø–ª–æ–π hakolr.dev%0A%0A–í–µ—Ç–∫–∞: ${{ github.ref_name }}%0A–ö–æ–º–º–∏—Ç: ${{ github.sha }}%0A–ê–≤—Ç–æ—Ä: ${{ github.actor }}"

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

      - name: Create backup before deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          ssh $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e
            cd ${{ secrets.PROJECT_PATH }}
            echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
            ./bin/bash/backup-db.sh || echo "‚ö†Ô∏è  Backup –Ω–µ —Å–æ–∑–¥–∞–Ω"
          ENDSSH

      - name: Deploy to VPS
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          ssh $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
            
            cd ${{ secrets.PROJECT_PATH }}
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            echo "üì• Git pull..."
            git fetch origin
            git reset --hard origin/main
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker-compose -f docker-compose.prod.yml down
            
            # –û—á–∏—Å—Ç–∫–∞
            echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
            docker image prune -f
            docker builder prune -f
            
            # –°–±–æ—Ä–∫–∞
            echo "üèóÔ∏è  –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
            docker-compose -f docker-compose.prod.yml build --no-cache
            
            # –ó–∞–ø—É—Å–∫
            echo "üöÄ –ó–∞–ø—É—Å–∫..."
            docker-compose -f docker-compose.prod.yml up -d
            
            # –û–∂–∏–¥–∞–Ω–∏–µ
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (30 —Å–µ–∫)..."
            sleep 30
            
            # –°—Ç–∞—Ç—É—Å
            echo "üìä –°—Ç–∞—Ç—É—Å:"
            docker-compose -f docker-compose.prod.yml ps
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          ENDSSH

      - name: Health check
        env:
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ frontend
          for i in {1..5}; do
            if curl -f -s -o /dev/null $FRONTEND_URL; then
              echo "‚úÖ Frontend –¥–æ—Å—Ç—É–ø–µ–Ω"
              break
            else
              echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/5..."
              sleep 10
            fi
          done
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ API
          API_URL="${FRONTEND_URL}/api/posts"
          if curl -f -s -o /dev/null $API_URL; then
            echo "‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚ö†Ô∏è  API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          fi

      - name: Get deployment info
        id: deploy_info
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          CONTAINERS_STATUS=$(ssh $SSH_USER@$SSH_HOST "cd ${{ secrets.PROJECT_PATH }} && docker-compose -f docker-compose.prod.yml ps --format json" | jq -r '.[] | "\(.Service): \(.State)"' | tr '\n' ', ')
          echo "containers_status=$CONTAINERS_STATUS" >> $GITHUB_OUTPUT

      - name: Send Telegram notification - Success
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚úÖ –î–µ–ø–ª–æ–π hakolr.dev –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!%0A%0Aüåê –°–∞–π—Ç: ${{ secrets.FRONTEND_URL }}%0Aüì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: ${{ steps.deploy_info.outputs.containers_status }}%0A‚è±Ô∏è –í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"

      - name: Send Telegram notification - Failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚ùå –î–µ–ø–ª–æ–π hakolr.dev –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!%0A%0A–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Cleanup on failure
        if: failure()
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          ssh $SSH_USER@$SSH_HOST << 'ENDSSH'
            cd ${{ secrets.PROJECT_PATH }}
            echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è..."
            docker-compose -f docker-compose.prod.yml up -d || true
          ENDSSH

